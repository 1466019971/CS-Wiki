# 💾 数据分析

---

## 1. 导入数据

直接 <img src="https://gitee.com/veal98/images/raw/master/img/20201024174946.png" style="zoom:67%;" /> 即可 😃

如果使用命令行的话，可参考 [MATLAB 官方文档](https://ww2.mathworks.cn/help/matlab/data-import-and-export.html?s_tid=CRUX_lftnav)

举个例子，加载 `count.dat` 中的数据：

```matlab
load count.dat
```

这个 24×3 数组 `count` 包含三个十字路口（列）在一天中的每小时流量统计（行）：

<img src="https://gitee.com/veal98/images/raw/master/img/20201023203638.png" style="zoom:67%;" />

## 2. 大型文件和大数据

## 3. 数据预处理

所谓预处理就是：通过将数据加载到合适的 MATLAB 容器变量并区分“正确”数据和“错误”数据，开始数据分析。这是初级步骤，可确保在后续的分析过程中得出有意义的结论。

### ① 清理缺失数据

MATLAB `NaN`（非数字）值或 `<missing>` 通常用于表示缺失数据。

| [`ismissing`](https://ww2.mathworks.cn/help/matlab/ref/ismissing.html) | 查找缺失值     |
| ------------------------------------------------------------ | -------------- |
| [`rmmissing`](https://ww2.mathworks.cn/help/matlab/ref/rmmissing.html) | 删除缺失的条目 |
| [`fillmissing`](https://ww2.mathworks.cn/help/matlab/ref/fillmissing.html) | 填充缺失值     |

#### 查找缺失值 ismissing

`TF = ismissing(A)` 返回逻辑数组，指示数组或表中的哪些元素包含缺失值。`TF` 的大小与 `A` 的大小相同。

标准缺失值取决于数据类型：

- `double`、`single`、`duration` 和 `calendarDuration` 的指示符为 `NaN`
- `datetime` 的指示符为 `NaT`
- `string` 的指示符为 ``
- `categorical` 的指示符为 ``
- `char` 的指示符为 `' '`
- 字符向量 `cell` 的指示符为 `{''}`

举个例子：

```matlab
A = [3 NaN 5 6 7 NaN NaN 9];
TF = ismissing(A)

TF = 1x8 logical array

   0   1   0   0   0   1   1   0
```

#### 删除缺失值 rmmissing

🔸 **`R = rmmissing(A)` 从数组或表中删除缺失的条目。如果 `A` 是向量，则 `rmmissing` 会删除包含缺失数据的所有条目。如果 `A` 是矩阵或表，则 `rmmissing` 会删除包含缺失数据的所有行**。缺失值的定义取决于 `A` 的数据类型：

- `NaN` - `double`、`single`、`duration` 和 `calendarDuration`
- `NaT` — `datetime`
- `` — `string`
- `` — `categorical`
- `' '` — `char`
- `{''}` - 字符数组的 `cell`

```matlab
A = [1 3 NaN 6 NaN];
R = rmmissing(A)
R = 1×3

     1     3     6
```

🔸 `R = rmmissing(A,dim)` 指定要沿其进行运算的 `A` 的维度。默认情况下，`rmmissing` 沿其大小不为 1 的第一个维度进行运算。

<img src="https://gitee.com/veal98/images/raw/master/img/20201024205503.png" style="zoom: 55%;" />

```matlab
>> A = [NaN NaN 5 3 NaN 5 7 NaN 9 2;
        8 9 NaN 1 4 5 6 5 NaN 5;
        NaN 4 9 8 7 2 4 1 NaN 3]

A =

   NaN   NaN     5     3   NaN     5     7   NaN     9     2
     8     9   NaN     1     4     5     6     5   NaN     5
   NaN     4     9     8     7     2     4     1   NaN     3

>> R = rmmissing(A,2) % 删除带有空缺值的第 2 个维度（列）

R =

     3     5     7     2
     1     5     6     5
     8     2     4     3
```

🔸 `R = rmmissing(___,Name,Value)` 使用一个或多个名称-值对组参数指定用来删除缺失条目的其他参数。例如，您可以使用 `rmmissing(A,'MinNumMissing',n)` 删除 `A` 的包含至少 `n` 个缺失值的行。

🔸 `[R,TF] = rmmissing(___)` 还返回与 `A` 中被删除的行或列对应的逻辑向量。

举个例子：

```matlab
A = [NaN NaN 5 3 NaN 5 7 NaN 9 2;
     8 9 NaN 1 4 5 6 5 NaN 5;
     NaN 4 9 8 7 2 4 1 NaN 3];

[R,TF] = rmmissing(A,2,'MinNumMissing',2)
R = 3×8

   NaN     5     3   NaN     5     7   NaN     2
     9   NaN     1     4     5     6     5     5
     4     9     8     7     2     4     1     3
TF = 1x10 logical array

   1   0   0   0   0   0   0   0   1   0
```

#### 填充缺失值 fillmissing

🔸 `F = fillmissing(A,'constant',v)` 使用常量值 `v` 填充缺失的数组或表条目。如果 `A` 是矩阵或多维数组，则 `v` 可以是标量或向量。如果 `v` 是向量，每个元素指定 `A` 对应列中的填充值。如果 `A` 是表或时间表，则 `v` 也可以是元胞数组。

缺失值的定义取决于 `A` 的数据类型：

- `NaN` - `double`、`single`、`duration` 和 `calendarDuration`
- `NaT` - `datetime`
- `<missing>` — `string`
- `<undefined>` - `categorical`
- `' '` - `char`
- `{''}` - 字符数组的 `cell`

如果 `A` 是表，则每列的数据类型定义该列的缺失值。

```matlab
 
A = [1 3 NaN 4 NaN NaN 5];
F = fillmissing(A,'constant',2)

F =

     1     3     2     4     2     2     5
```

🔸 `F = fillmissing(A,method)` 使用 `method` 指定的方法填充缺失的条目。例如，`fillmissing(A,'previous')` 对 `A` 中的缺失条目使用上一个非缺失条目进行填充。

```matlab
A = [1 3 NaN 4 NaN NaN 5];
F = fillmissing(A,'previous')
F = 1×7

     1     3     3     4     4     4     5
```

`F = fillmissing(___,dim)` 指定要沿其进行运算的 `A` 的维度。默认情况下，`fillmissing` 沿其大小不为 1 的第一个维度进行运算。例如，如果 `A` 是矩阵，则 `fillmissing(A,2)` 跨 `A` 的各列进行运算，逐行填充缺失的数据。

### ② 清理离群值

**离群值是与其余数据中的模式明显不同的数据值**。默认情况下，离群值是指与中位数相差超过三倍经过换算的[中位数绝对偏差 (MAD)](https://ww2.mathworks.cn/help/matlab/ref/isoutlier.html#bvolfgk) 的值。离群值可能由计算错误所致，也可能表示数据的重要特点。根据对数据及数据源的了解，确定离群值并决定其处理方法。

#### 查找离群值 isoutlier

🔸 `TF = isoutlier(A)` 返回一个逻辑数组，当在 `A` 的元素中检测到离群值时，该数组中与之对应的元素为 `true`。如果 `A` 是矩阵或表，则 `isoutlier` 分别对每一列进行运算。如果 `A` 是多维数组，则 `isoutlier` 沿大小不等于 1 的第一个维度进行运算。

```matlab
A = [57 59 60 100 59 58 57 58 300 61 62 60 62 58 57];
TF = isoutlier(A)
TF = 1x15 logical array

   0   0   0   1   0   0   0   0   1   0   0   0   0   0   0
```

🔸 `TF = isoutlier(A, findmethod)` 指定检测离群值的方法。例如，`isoutlier(A,'mean')` 对偏离均值超过三倍标准差的所有元素返回 `true`

| 检测方法 findmethod | 说明                                                         |
| :------------------ | :----------------------------------------------------------- |
| `'median'`          | 离群值定义为与中位数相差超过三倍换算 MAD 的元素。换算 MAD 定义为 `c*median(abs(A-median(A)))`，其中 `c=-1/(sqrt(2)*erfcinv(3/2))`。 |
| `'mean'`            | 离群值定义为与均值相差超过三倍标准差的元素。此方法比 `'median'` 快，但没有它可靠。 |
| `'quartiles'`       | 离群值定义为比上四分位数 (75%) 大 1.5 个四分位差以上或比下四分位数 (25%) 小 1.5 个四分位差以上的元素。当 `A` 中的数据不是正态分布时，此方法很有用。 |
| `'grubbs'`          | 使用 Grubbs 检验检测离群值，并基于假设检验每次迭代删除一个离群值。此方法假设 `A` 中的数据呈正态分布。 |
| `'gesd'`            | 使用广义极端 Student 偏差检验检测离群值。此迭代方法与 `'grubbs'` 类似，但当有多个离群值互相遮盖时，此方法的执行效果更好。 |

```matlab
A = [57 59 60 100 59 58 57 58 300 61 62 60 62 58 57];
TF = isoutlier(A,'mean')
TF = 1x15 logical array

   0   0   0   0   0   0   0   0   1   0   0   0   0   0   0
```

🔸 `TF = isoutlier(___,dim)` 将沿 `A` 的维度 `dim` 运算。例如，`isoutlier(A,2)` 沿矩阵 `A` 的每一行运算。

#### 删除离群值 rmoutliers

🔸 `B = rmoutliers(A)` 检测并删除向量、矩阵、表或时间表的数据中的离群值。

- 如果 `A` 是行向量或列向量，`rmoutliers` 会检测离群值并将其删除。
- 如果 `A` 是矩阵、表或时间表，`rmoutliers` 会分别检测 `A` 的每个列或变量中的离群值并删除整行。

默认情况下，离群值是指超过三倍经过换算的中位数绝对偏差 (MAD) 的值。

🔸 `B = rmoutliers(A,method)` 指定确定离群值的方法。例如，`rmoutliers(A,'findmean')` 将 `A` 中与均值相差超过三倍标准差的元素定义为离群值。

🔸 `B = rmoutliers(___,dim)` 在上述任何语法的基础上沿 `A` 的维度 `dim` 删除离群值。例如，`rmoutliers(A,2)` 删除矩阵 `A` 的列而不是行。

🔸 `[B,TF] = rmoutliers(___)` 还返回与 `A` 中被删除的行或列对应的逻辑向量。

```matlab
A = [57 59 60 100 59 58 57 58 300 61 62 60 62 58 57];
[B,TF] = rmoutliers(A)

B = 1×13

    57    59    60    59    58    57    58    61    62    60    62    58    57
    
TF = 1x15 logical array

   0   0   0   1   0   0   0   0   1   0   0   0   0   0   0
```

#### 替换离群值 filloutliers

🔸 `B = filloutliers(A,fillmethod)` 查找 `A` 中的离群值并根据 `fillmethod` 替换它们。例如，`filloutliers(A,'previous')` 将离群值替换为上一个非离群值元素。如果 `A` 是矩阵或表，则 `filloutliers` 分别对每一列进行运算。如果 `A` 是多维数组，则 `filloutliers` 沿大小不等于 1 的第一个维度进行运算。

| 填充方法     | 说明                                                         |
| :----------- | :----------------------------------------------------------- |
| 数值标量     | 使用指定的标量值进行填充                                     |
| `'center'`   | 使用由 `findmethod` 决定的中心值进行填充                     |
| `'clip'`     | 对于比 `findmethod` 决定的下阈值还小的元素，用下阈值填充。对于比 `findmethod` 决定的上阈值还大的元素，用上阈值填充。 |
| `'previous'` | 使用上一个非离群值进行填充                                   |
| `'next'`     | 使用下一个非离群值进行填充                                   |
| `'nearest'`  | 使用最接近的非离群值进行填充                                 |
| `'linear'`   | 使用相邻的非离群值的线性插值进行填充                         |
| `'spline'`   | 使用分段三次样条插值进行填充                                 |
| `'pchip'`    | 使用保形分段三次样条插值进行填充                             |
| `'makima'`   | 修正 Akima 三次 Hermite 插值（仅限数值、`duration` 和 `datetime` 数据类型） |

举个例子：

```matlab
A = [57 59 60 100 59 58 57 58 300 61 62 60 62 58 57];
B = filloutliers(A,'linear');
plot(1:15,A,1:15,B,'o')
legend('Original Data','Interpolated Data')
```

![](https://gitee.com/veal98/images/raw/master/img/20201024215111.png)

🔸 `B = filloutliers(A,fillmethod,findmethod)` 指定检测离群值的方法。例如，`filloutliers(A,'previous','mean')` 将 `A` 中与均值相差超过三倍标准差的元素定义为离群值。

🔸 `B = filloutliers(___,dim)` 将沿 `A` 的维度 `dim` 运算。例如，`filloutliers(A,'linear',2)` 沿矩阵 `A` 的每一行运算。

### ③ 平滑和筛选

以 `count.dat` 文件为例：

```matlab
load count.dat
```

<img src="https://gitee.com/veal98/images/raw/master/img/20201023203638.png" style="zoom:67%;" />

第三个十字路口的数据时序图（已在离群值中删除该离群值）生成以下绘图：

```matlab
c3m = count(:,3)
plot(c3m,'o-')
hold on
```

![](https://gitee.com/veal98/images/raw/master/img/20201023204912.png)

在绘图中，第 20 个小时的 `NaN` 值出现间隔。这种对 `NaN` 值的处理方式是 MATLAB 绘图函数所特有的。

噪音数据围绕预期值显示随机变化。您**可能希望在构建模型之前对数据进行平滑处理，以便显示其主要特点**。平滑处理应当以下面两个基本假定为基础：

- 预测变量（时间）和响应（流量）之间的关系平稳。

- 由于已减少噪音，因此平滑算法生成比预期值更好的估计值。

使用 MATLAB `convn` 函数对数据应用简单移动平均平滑法：

```matlab
span = 3; % Size of the averaging window
window = ones(span,1)/span; 
smoothed_c3m = convn(c3m,window,'same');

h = plot(smoothed_c3m,'ro-');
legend('Data','Smoothed Data')
```

![](https://gitee.com/veal98/images/raw/master/img/20201023205150.png)

**使用变量 `span` 控制平滑范围**。当平滑窗口在数据中包含 `NaN` 值时，平均值计算返回 `NaN` 值，从而增大平滑数据中的间隔大小。

此外，还可以对平滑数据使用 `filter` 函数：

```matlab
smoothed2_c3m = filter(window,1,c3m);

delete(h)
plot(smoothed2_c3m,'ro-','DisplayName','Smoothed Data');
```

![](https://gitee.com/veal98/images/raw/master/img/20201023205243.png)

平滑数据在以上绘图的基础上发生了偏移。带有 `'same'` 参数的 `convn` 返回卷积的中间部分，其长度与数据相同。`filter` 返回卷积的开头，其长度与数据相同。否则算法相同。

平滑处理可估计预测变量的每个值的响应值分布的中心。它使许多拟合算法的基本假定无效，即*预测器的每个值的错误彼此独立*。相应地，**您可以使用平滑数据确定模型，但应避免使用平滑数据拟合模型**。

## 4. 可视化数据

绘图函数非常多，此处就以散点图举个例子  👇

### ① 二维散点图

二维散点图使用 `scatter` 函数创建，用于显示前两个十字路口的流量之间的关系：

```matlab
load count.dat
c1 = count(:,1); % Data at intersection 1
c2 = count(:,2); % Data at intersection 2

scatter(c1,c2,'filled')
xlabel('Intersection 1')
ylabel('Intersection 2')
```

![](https://gitee.com/veal98/images/raw/master/img/20201024164615.png)

使用 `cov` 函数计算的**【协方差】**计算两个变量之间的线性关系强度（数据在散点图中沿着最小二乘直线排列的松紧度）：

```matlab
C12 = cov([c1 c2])
C12 = 2×2
103 ×

    0.6437    0.9802
    0.9802    1.7144
```

结果以对称的方阵形式显示，并在第 (i, j) 个位置中显示第 i 个和第 j 个变量的协方差。第 i 个对角线元素是第 i 个变量的方差。

Q：**协方差的缺点是：取决于度量各个变量所使用的单位**。

A：您可以将变量的协方差除以标准差（即**【相关系数 Correlation coefficient】**），以将协方差的值【**归一化】**为介于 +1 和 –1 之间。`corrcoef` 函数计算*相关系数*：

```matlab
R12 = corrcoef([c1 c2])
R12 = 2×2

    1.0000    0.9331
    0.9331    1.0000
r12 = R12(1,2) % 相关系数
r12 = 0.9331
```

由于已经过归一化，因此相关系数的值可以方便地与其他成对的十字路口的值相比较。

### ② 三维散点图

三维散点图使用 [`scatter3`](https://ww2.mathworks.cn/help/matlab/ref/scatter3.html) 函数创建，用于显示所有三个十字路口的流量之间的关系：使用在上述步骤中创建的变量 `c1`、`c2` 和 `c3`：

```matlab
figure % 打开新的图窗窗口并将其作为当前图窗
c3 = count(:,3); % Data at intersection 3
scatter3(c1,c2,c3,'filled')
xlabel('Intersection 1')
ylabel('Intersection 2')
zlabel('Intersection 3')
```

![](https://gitee.com/veal98/images/raw/master/img/20201024165613.png)

通过使用 [`eig`](https://ww2.mathworks.cn/help/matlab/ref/eig.html) 函数计算**【协方差矩阵的特征值】**来度量三维散点图中的变量之间的线性关系强度：

```matlab
vars = eig(cov([c1 c2 c3]))
vars = 3×1
103 ×

    0.0442
    0.1118
    6.8300
```

## 5. 描述性统计量



## 2. 汇总数据

许多 MATLAB 函数都可以用于汇总数据样本的总体位置、规模和形状。

使用 MATLAB 的一大优点是：**函数处理整个数据数组，而不是仅处理单一标量值。这些函数称为【向量化函数】**。通过向量化可以进行有效的问题公式化（使用基于数组的数据）和有效计算（使用向量化统计函数）。

### ① 位置度量

通过定义“典型”值来汇总数据示例的位置。使用函数 `mean`、`median` 和 `mode` 计算常见位置度量或“集中趋势”：

```matlab
load count.dat

x1 = mean(count) % 每列的平均值
x1 = 1×3

   32.0000   46.5417   65.5833
   
x2 = median(count) % 每列的中位数
x2 = 1×3

   23.5000   36.0000   39.0000
   
x3 = mode(count) % 每列出现次数最多的值
x3 = 1×3

    11     9     9 
```

与所有统计函数一样，上述 MATLAB® 函数汇总多个列中的数据，并保留变量（列）。这些函数在一次调用中计算三个十字路口中的每个十字路口的数据位置。

### ② 规模度量

有多种方法可以度量数据样本的规模或“分散程度”。MATLAB 函数 `max`、`min`、`std` 和 `var` 计算某些常见度量：

```matlab
dx1 = max(count)-min(count) % 每列中最大值减最小值
dx1 = 1×3

   107   136   250
dx2 = std(count)  % 每列的标准差
dx2 = 1×3

   25.3703   41.4057   68.0281
   
dx3 = var(count) % 每列的方差
dx3 = 1×3
103 ×

    0.6437    1.7144    4.6278
```

与所有统计函数一样，上述 MATLAB® 函数汇总多个列中的数据，并保留变量（列）。这些函数在一次调用中计算三个十字路口中的每个十字路口的数据规模。

### ③ 分布形状

汇总分布的形状比汇总分布的位置或规模更难。MATLAB  `hist` 函数绘制直方图，可视化显示汇总数据：

```matlab
figure
hist(count)
legend('Intersection 1',...
       'Intersection 2',...
       'Intersection 3')
```

![](https://gitee.com/veal98/images/raw/master/img/20201023210422.png)

参数模型提供分布形状的汇总分析。指数分布和数据均值指定的参数 `mu` 非常适用于流量数据：

```matlab
c1 = count(:,1); % Data at intersection 1
[bin_counts,bin_locations] = hist(c1);
bin_width = bin_locations(2) - bin_locations(1);
hist_area = (bin_width)*(sum(bin_counts));

figure
hist(c1)
hold on

mu1 = mean(c1);
exp_pdf = @(t)(1/mu1)*exp(-t/mu1); % Integrates
                                   % to 1
t = 0:150;
y = exp_pdf(t);
plot(t,(hist_area)*y,'r','LineWidth',2)
legend('Distribution','Exponential Fit')
```

![](https://gitee.com/veal98/images/raw/master/img/20201023210729.png)

## 4. 数据建模

参数模型将对数据关系的理解转换为具有预测能力的分析工具。对于流量数据的上升和下降趋势，多项式模型和正弦模型是理想选择。

### ① 多项式回归

使用 `polyfit` 函数估计多项式模型的系数，然后使用 `polyval` 函数根据预测变量的任意值评估模型。

- 🔸 `p = polyfit(x,y,n)`  返回次数为 `n` 的多项式 `p(x)` 的系数，该阶数是 `y` 中数据的最佳拟合（在最小二乘方式中）。`p` 中的系数按降幂排列，`p` 的长度为 `n+1`

<img src="https://gitee.com/veal98/images/raw/master/img/20201024171233.png" style="zoom: 67%;" />

- 🔸 `y = polyval(p,x)` 计算多项式 `p` 在 `x` 的每个点处的值。参数 `p` 是长度为 `n+1` 的向量，其元素是 `n` 次多项式的系数

以下代码使用 6 次多项式模型拟合第三个十字路口的流量数据：

```matlab
load count.dat
c3 = count(:,3); % Data at intersection 3 
tdata = (1:24)'; 
plot(c3,'o-') 

hold on 

p_coeffs = polyfit(tdata,c3,6); % 求出6 次多项式模型的参数
tfit = (1:0.01:24)'; 
yfit = polyval(p_coeffs,tfit); 
plot(tfit,yfit,'r-','LineWidth',2)

legend('Data','Polynomial Fit')
```

<img src="https://gitee.com/veal98/images/raw/master/img/20201024172150.png" style="zoom:67%;" />

🚨 **此模型的优点是可以非常简单地跟踪升降趋势。但是，此模型的预测能力可能有欠准确性，特别是在数据两端**。

### ② 一般线性回归

假定数据是周期为 12 个小时的周期性数据，并且峰值出现在第 7 个小时左右，拟合以下形式的正弦模型是合理的：

<img src="https://gitee.com/veal98/images/raw/master/img/20201024172336.png" style="zoom:67%;" />

系数 *a* 和 *b* 呈线性关系。使用 MATLAB `mldivide`（反斜杠 `\`）运算符拟合一般线性模型：

- 🚨 **对线性方程组 `Ax = B` 求解 `x` 使用 `\`，即 `x = A\B`**

```matlab
load count.dat
c3 = count(:,3); % Data at intersection 3 
tdata = (1:24)'; 
plot(c3,'o-')

hold on

X = [ones(size(tdata)) cos((2*pi/12)*(tdata-7))];
s_coeffs = X\c3;
tfit = (1:0.01:24)';
yfit = [ones(size(tfit)) cos((2*pi/12)*(tfit-7))]*s_coeffs; 
plot(tfit,yfit,'r-','LineWidth',2)

legend('Data','Sinusoidal Fit','Location','NW')
```

![](https://gitee.com/veal98/images/raw/master/img/20201024172537.png)

## 📚 References

- [MATLAB R2020a 官方文档](https://ww2.mathworks.cn/help/matlab/index.html)