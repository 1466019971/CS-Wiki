# 🛀 查询处理和优化



## 一、一条查询 SQL 语句的执行流程和底层原理

**查询sql语句执行流程图**

![](https://gitee.com/veal98/images/raw/master/img/20200416214548.png)

具体执行流程：

以这条sql语句为例

```sql
select * from tb_student  A where A.age='18' and A.name=' 张三 ';
```

- **查询缓存：**

  先检查该语句是否有权限，如果没有权限，直接返回错误信息，如果有权限，在 MySQL8.0 版本以前，会先查询缓存，以这条 sql 语句为 key 在内存中查询是否有结果，如果有直接缓存，如果没有，执行下一步。

- **分析器：**

  分析器执行流程分为两个阶段，词法分析和语法分析

  通过分析器进行词法分析，提取 sql 语句的关键元素，比如提取上面这个语句是查询 select，提取需要查询的表名为 tb_student, 需要查询所有的列，查询条件是这个表的 id='1'。

  然后判断这个 sql 语句是否有语法错误，比如关键词是否正确等等，如果解析器顺利生成语法树，就会将SQL送发到预处理器

- **预处理器**

  预处理器主要做两件事情，查看SQL中列名是否正确和权限验证

  ① 首先判断SQL语句中的列名是否存在于数据表中，再看看表名是否正确，如果不对，将返回如下错误提示

  ```
  Unknown column xxx in ‘where clause’
  ```

  ② 预处理器对SQL进行权限验证，判断SQL是否有操作这个表的权限，若没有，则会返回如下错误信息

  ```
  ERROR 1142 (42000): SELECT command denied to user 'root'@'localhost' for table 'xxx'
  ```

   一切验证通过后将语法树传递给优化器

- **优化器：**

  接下来就是优化器进行确定执行方案，上面的 sql 语句，可以有两种执行方案：

  ```
    a.先查询学生表中姓名为“张三”的学生，然后判断是否年龄是 18。
    b.先找出学生中年龄 18 岁的学生，然后再查询姓名为“张三”的学生。
  ```

  优化器根据自己的优化算法进行选择执行效率最好的一个方案（优化器认为，有时候不一定最好）。优化器对SQL优化完成后会将SQL变成一个执行计划交给执行器

- **执行器：**

  执行器就是根据执行计划来进行执行查询， 根据SQL的指令，逐条调用底层存储引擎，逐步执行并返回引擎的执行结果。